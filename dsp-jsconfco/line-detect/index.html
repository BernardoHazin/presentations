<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Image Compress</title>
	<style type="text/css">
		body {
			width: 1000px;
			margin: 0 auto;
		}
		.canvas {
			margin: 10px auto;
			border: 1px solid #000;
		}
	</style>
</head>
<body>

	<canvas id="canvas" class="canvas" width="460" height="300"></canvas>
  <!-- 
	<canvas id="canvas2" class="canvas" width="990" height="350"></canvas>
 -->
<!-- 
	<script type="text/javascript" src="../lodash.js"></script>
	<script type="text/javascript" src="../compress.js"></script>
 -->
  <script type="text/javascript" src="../lodash.js"></script>
	<script type="text/javascript">
		var canvas = document.getElementById('canvas');
		var ctx = canvas.getContext('2d');
    var lefter = canvas.width * 4;
    var righter = 0;

    var r = 255;
    var g = 255;
    var b = 255;

    var tolerance = 15;

    var isRed
    var isGreen
    var isBlue

    // loadImage('elipse.png');
    loadImage('eye3.jpg')

		function imageLoaded () {
    
      iterateLines()
		}

    function iterateLines () {
      var imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      var len = canvas.height;
      var consecutives = [];
      var counts;
      var max;

      for (var i = 0; i < len; i++) {
        counts = checkLine(i, canvas, imgData)
        consecutives.push(counts)
      }

      max = _.max(consecutives)

      paintLine(consecutives.indexOf(max), canvas, imgData)
      ctx.putImageData(imgData, 0, 0)
    }

    function checkLine (line, canvas, imgData) {
      var w = canvas.width
      var start = line * w * 4
      var end = start + w * 4
      var isTargetColor
      var counts = 0
      var colorCounts = []
      var bigger = 0;

      for (var i = start; i < end; i += 4) {
        
        isTargetColor = isColor(imgData.data, i, r, g, b, tolerance)

        if (isTargetColor) {
          counts++

          // imgData.data[i] = 255;
        }

        if (!isTargetColor) {
          if (counts > bigger) {
            bigger = counts;
          }          
          counts = 0;
        }
      }

      return bigger
    }

    function paintLine (line, canvas, imgData) {
      var start = line * 4 * canvas.width
      var end = line * 4 * canvas.width +  4 * canvas.width

      for (var i = start; i < end; i+= 4) {
        imgData.data[i] = 255;
        imgData.data[i+1] = 0;
        imgData.data[i+2] = 0;
      }
    }


    function isColor (data, i, r, g, b, tolerance) {
      var isRed = (r + tolerance) > data[i] && data[i] > (r - tolerance) 
      var isGreen = (g + tolerance) > data[i+1] && data[i+1] > (g - tolerance)
      var isBlue = (b + tolerance) > data[i+2] && data[i+2] > (b - tolerance)

      return isRed && isGreen && isBlue;
    }

    function foundBoundaries () {
      var imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      var pos;

      for (var i = 0; i < imgData.data.length; i+=4) {
        isRed = (r + tolerance) > imgData.data[i] && imgData.data[i] > (r - tolerance) 
        isGreen = (g + tolerance) > imgData.data[i+1] && imgData.data[i+1] > (g - tolerance)
        isBlue = (b + tolerance) > imgData.data[i+2] && imgData.data[i+2] > (b - tolerance)

        if (isRed && isGreen && isBlue) { 
          pos = i % (canvas.width * 4)

          pos < lefter ? lefter = pos : null
          pos > righter ? righter = pos : null

          imgData.data[i] = 0
          imgData.data[i+1] = 0
          imgData.data[i+2] = 0
        }

      }

      ctx.fillStyle = "rgb(255,0,0)";

      ctx.putImageData(imgData, 0, 0)
    }

		function loadImage(src) {
		  base_image = new Image();

		  base_image.src = src;
		  base_image.onload = function(){
		    ctx.drawImage(base_image, 0, 0);
		    imageLoaded(base_image);
		  }
		}
	</script>
</body>
</html>